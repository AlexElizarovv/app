SetEnvIf Remote_Addr "127\.0\.0\.1" loopback
LogFormat "{ \"appname\": \"mediawiki-k8s-apache-access-logs\", \"time\":\"%{%Y-%m-%dT%T}t\", \"response_time\": %D, \"remoteIP\":\"%a\", \"host\":\"%V\", \"request\":\"%U\", \"query\":\"%q\", \"method\":\"%m\", \"status\":\"%>s\", \"userAgent\":\"%{User-agent}i\", \"referer\":\"%{Referer}i\" }" k8s_apache_access_logs

<VirtualHost *:8080>
  ServerName mediawiki.poz-dev.k8s.wikia.net

  CustomLog /dev/stdout k8s_apache_access_logs env=!loopback

  # send emails to blackhole
  ServerAdmin devbox@wikia-inc.com

  ServerAlias *.dev.wikia-local.com
  # some services ask for production hostnames, this lowers config differences between prod/dev
  ServerAlias *.wikia-local.com

  RewriteEngine on

  #Resource Loader rewrite
  RewriteRule ^/__load/[^/]*/([^/]*)/([^$].+) /load.php?modules=$2&$1 [L,PT]
  #AssetsManager Rewrite
  RewriteRule ^/__am/(\d+)/([A-Za-z]+)/([^/]*)/(.*) /index.php?action=ajax&rs=AssetsManagerEntryPoint&cb=$1&type=$2&params=$3&oid=$4 [NE,B,L]
  RewriteRule ^/opensearch_desc.php - [L]
  RewriteRule ^/extensions(.*) - [L]
  RewriteRule ^/skins(.*) - [L]
  RewriteRule ^/static/(.*) - [L]
  RewriteRule ^/index.php(.*) - [L]
  RewriteRule ^/wikia.php(.*) - [L]
  # force pre-existing lyricwiki API calls to use a MediaWiki-compliant query
  RewriteCond %{QUERY_STRING} ^.*func=.*
  RewriteRule ^/api.php /api.php?action=lyrics [L,QSA]
  RewriteRule ^/api.php(.*) - [L]
  RewriteRule ^/robots.txt /wikia-robots-txt.php [L]
  RewriteRule ^/(sitemap.+\.xml[.gz]*)$ /index.php?title=Special:Sitemap/$1&uselang=en [L]
  RewriteRule ^/wiki/[cC]:([^:]*)(.*) http://$1.wikia.com/wiki/$2 [R=301,L,QSA]

  # Wikia API V1 URL Rewrites
  RewriteRule ^/api/(?:v1|test)/?$ /wikia.php?controller=ApiDocs&method=index [L,QSA]
  RewriteRule ^/api/(?:v1|test)/([^/]*)/([^/]*) /wikia.php?controller=$1Api&method=get$2 [L,QSA]

  RewriteRule ^/wiki/index\.php/(.*) /wiki/$1 [L,QSA,R=301,NE]
  RewriteRule ^/w/(.*) /wiki/$1 [L,QSA,R=301,NE]
  RewriteRule ^/wiki/(.*) /index.php?title=$1 [L,QSA]

  # Set of rules for language path in the url. For performance reasons they are put
  # below the English rules

  #Article url
  RewriteRule ^/[a-z]{2,3}(?:-[a-z-]{2,12})?/wiki/(.*) /index.php?title=$1 [L,QSA]

  #Resource Loader rewrite for language wikis
  RewriteRule ^/[a-z]{2,3}(?:-[a-z-]{2,12})?/__load/[^/]*/([^/]*)/([^$].+) /load.php?modules=$2&$1 [L,PT]
  #AssetsManager Rewrite
  RewriteRule ^/[a-z]{2,3}(?:-[a-z-]{2,12})?/__am/(\d+)/([A-Za-z]+)/([^/]*)/(.*) /index.php?action=ajax&rs=AssetsManagerEntryPoint&cb=$1&type=$2&params=$3&oid=$4 [NE,B,L]

  # the directories below are the same for each wiki, so just strip the language
  RewriteRule ^/[a-z]{2,3}(?:-[a-z-]{2,12})?/extensions/(.*) /extensions/$1 [L]
  RewriteRule ^/[a-z]{2,3}(?:-[a-z-]{2,12})?/skins/(.*) /skins/$1 [L]
  RewriteRule ^/[a-z]{2,3}(?:-[a-z-]{2,12})?/static/(.*) /static/$1 [L]
  RewriteRule ^/[a-z]{2,3}(?:-[a-z-]{2,12})?/index.php(.*) /index.php$1 [L]
  RewriteRule ^/[a-z]{2,3}(?:-[a-z-]{2,12})?/wikia.php(.*) /wikia.php$1 [L]
  RewriteRule ^/[a-z]{2,3}(?:-[a-z-]{2,12})?/api.php(.*) /api.php$1 [L]
  RewriteRule ^/[a-z]{2,3}(?:-[a-z-]{2,12})?/opensearch_desc.php(.*) /opensearch_desc.php$1 [L]
  # load.php rewrite for language wiki
  RewriteRule ^/[a-z]{2,3}(?:-[a-z-]{2,12})?/load.php(.*) /load.php$1 [L]

  # sitemaps
  RewriteRule ^/[a-z]{2,3}(?:-[a-z-]{2,12})?/(sitemap.+\.xml[.gz]*)$ /index.php?title=Special:Sitemap/$1&uselang=en [L]

  # Wikia API V1 URL Rewrites
  RewriteRule ^/[a-z]{2,3}(?:-[a-z-]{2,12})?/api/(?:v1|test)/?$ /wikia.php?controller=ApiDocs&method=index [L,QSA]
  RewriteRule ^/[a-z]{2,3}(?:-[a-z-]{2,12})?/api/(?:v1|test)/([^/]*)/([^/]*) /wikia.php?controller=$1Api&method=get$2 [L,QSA]

  # rewrite for language wiki root path
  RewriteRule ^/[a-z]{2,3}(?:-[a-z-]{2,12})?/$ /index.php [L]

  # this rss rule works but might be unused
  RewriteRule ^/rss/(.*) /index.php?title=$1&feed=rss [L,QSA]

  ErrorDocument 404 /redirect-canonical.php

  <Directory "/var/www/html">
    Options ExecCGI FollowSymLinks
    AllowOverride AuthConfig FileInfo Limit
    DirectoryIndex index.php
    FallbackResource /index.php
  </Directory>
</VirtualHost>
